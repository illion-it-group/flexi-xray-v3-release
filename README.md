## Flexi XRay v3

> [!NOTE]
> **Main repository:** [/illion-it-group/flexi-xray-v3](https://github.com/illion-it-group/flexi-xray-v3)

> [!NOTE]
> **Based on:** [illionitgroup/flexi-xray-v2](https://bitbucket.org/illionitgroup/flexi-xray-v2)

> [!NOTE]
> **Changelog:** [CHANGELOG.md](CHANGELOG.md)

Windows agent and utilities for integrating dental X‑ray applications with the Flexi‑Dent CRM system. The agent registers the machine, handles deep‑link protocol calls, starts and watches X‑ray application output folders, converts images when necessary, and uploads them to the clinic backend.

### Repository layout

- `Flexi.XRay.v3/`
  - `Flexi.XRay.v3.Agent/`: Windows Forms tray application and core services (protocol handling, folder watchers, upload pipeline, UI, auto‑update)
  - `packages/`: NuGet dependencies (fo‑dicom, LibTiff.NET, Newtonsoft.Json, Sentry, etc.)
- `installer.iss`, `installer-build/`: Inno Setup and built installers

---

### Key features

- **Single‑instance agent**: Ensures a single running instance and routes subsequent protocol calls to the main window
- **Deep‑link protocol handling**: Handles `flexi://...` and `xrayproxy://...` *(or custom)* URLs and special commands (e.g., register, shutdown)
- **Machine registration**: Registers the local machine with the clinic backend
- **Application info discovery**: Fetches per‑machine/per‑software configuration from backend
- **Folder watcher orchestration**:
  - Creates and manages file system watchers for the active X‑ray application
  - Optional per‑Windows‑user watcher segregation
  - TTL and auto‑cleanup of inactive watchers
- **Image normalization & conversion**:
  - Converts BMP, TIFF, DICOM (`.dcm`) to upload‑ready images
  - Extension‑based conversion via `Converters/` (LibTiff.NET and fo‑dicom)
- **Upload pipeline**:
  - Calculates image GUID (MD5 of file content)
  - Uploads via multipart/B64 to cloud endpoints
  - Optional duplicate check for Conexio VDDS workflow
- **UI and status widget**:
  - WinForms UI with console log view and watcher grid
  - Optional floating watcher status widget
  - Open watcher folder, disable watcher, open patient cardboard in browser
- **Auto‑update**: Checks GitHub releases and suggests in‑app upgrades; optional interval checks
- **Logging & diagnostics**: In‑app console, file logging, Sentry crash/error capture

---

### Architecture overview

- `Program.cs` (Agent):
  - Initializes single instance; wires Sentry; loads/stores configuration; validates registry protocol handlers; starts UI
- `ProtocolHandler` and `ProtocolTranslator`:
  - Parses incoming protocol URLs, translates to `XRayMessage` with patient + app context
  - Handles special URLs like `flexi://register|<apiKey>` and `flexi://shutdown`
- `FolderWatcherHandler` and `FolderWatcher`:
  - Adds/removes watchers; debounces locked files via waitlist; fires convert/upload jobs
- `ImageUploader` and `Client`:
  - Uploads using configured endpoints (v1/v2, raw or Base64)
- `Forms/Form_UI`:
  - Log console, watcher list, basic actions, settings editor, update checker

---

### Supported protocol URLs

- Application launch and watcher provisioning: `flexi://...` or `xrayproxy://...` generated by Flexi‑Dent (exact query schema is parsed internally by `ProtocolTranslator`)
- The usage of custom protocol handlers is possible by changing the `ProtocolHandlers` property in the configuration.
- Special actions:
  - `flexi://register|<API_KEY>`: Registers this machine with the backend
  - `flexi://shutdown` or `xrayproxy://shutdown`: Stops all active watchers

The agent validates OS protocol handler registration at startup based on `SoftwareSettings.ProtocolHandlers`.

---

### Settings and configuration

The agent persists a strongly‑typed XML configuration alongside the executable:

- File: `<AppBase>/config.xml` (path exposed as `SoftwareSettings.ConfigPath`)
- Life‑cycle: created on first run with sensible defaults; loaded and optionally re‑saved on subsequent runs
- UI: editable via PropertyGrid in the main window; changes persisted immediately

Core settings (selected, see source for full list in `Classes/Models/SoftwareSettings.cs`):

- Core
  - `ProtocolHandlers`: default `['flexi','xrayproxy']`
  - `AutoUpdate`, `AutoUpdateIntervalMinutes`, `UpdatePrerelease`, `UpdateRepository`
  - `ShowWatcherWidget`: toggles the floating watchers status widget (restart required)
  - `GuidStorageMode`: where the installation GUID is stored (Registry options)
- Modes
  - `DebugMode`: include debug entries in UI log
  - `IsLive`, `IsSOTE`: controls `SiteBaseAddress` selection (live vs. special SOTE)
  - `FirstNameLastNameExchanged`: name ordering for certain integrations
  - `DisableTheStartOfRtgSoftware`: do not auto‑start the X‑ray application
  - `StartApplicationsSync`: legacy app start synchronization
  - `UseNewAPIFunction`: selects v2 endpoints (read‑only in UI)
- Folder watcher
  - `BuildWatchersBasedOnLocalUsers`: create per‑user watchers
  - `FileUploadUseChangedEvent`: also respond to file change events
  - `ExcludedFolderNames`, `ExcludeExtensionsFromUpload`
  - `FileWatcherTimeLimit` (ms between uploads), `FileWatcherTimeout` (sec until watcher auto‑stop)
- Paths
  - `ConvertedFilePath`: default in `%PROGRAMDATA%/Flexi‑Dent/ConvertedImages/`
- Network addresses (read‑only defaults)
  - `SiteBaseAddress`, `SitePostAddress`/`V2`, `UploadImageAsBase64Address`
  - `SiteGetApplicationInfoAddress`/`V2`, `SiteImageCheckAddress`, `SiteRegisterMachine`, `SitePatientCardboard`
- App‑specific toggles
  - Sidexis: `SidexisUseUTF8`, `SidexisWriteUTF8File`, etc.
  - Morita: `MoritaUseExeParams`
  - Carestream: `CareStreamUsePatientFolder` (may create per‑patient subfolders, with optional network share access)
  - Cliniview: `UseTargetMachineWindowsDateFormat`
  - Conexio: `ConexioIniFilePath` (auto‑set into `%PROGRAMDATA%/Flexi‑Dent/Conexio/conexio.ini`)
  - Digora: `DigoraInitialWaitTime`
  - DTX Studio: `DTXWaitForSyncOutput`

Configuration API:

- Initialization: `SoftwareSettingsHandler.Init()` creates/loads and runs `SoftwareSettings.Init()`
- Save: `SoftwareSettingsHandler.StoreConfiguration()`
- Restore defaults: `SoftwareSettingsHandler.RestoreDefaultConfiguration()`

---

### Watchers and upload flow

1) A protocol URL arrives and is translated to `XRayMessage` (patient, app, folder, API credentials)
2) `FolderWatcherHandler.ProcessXRayMessage` ensures the watch folder exists (with Carestream patient folder rules), removes conflicting watchers, and adds a new watcher
3) On file create/change:
   - If the file is locked, it is queued on a waitlist for up to 30 minutes and retried periodically
   - On readiness, the converter normalizes BMP/TIFF/DICOM as needed into `ConvertedFilePath`
   - The uploader computes MD5, sets metadata, and posts to the configured endpoint
4) The UI reflects status, and a tray balloon is shown upon successful upload

---

### Installer:

- Inno Setup script: `installer.iss`
- Prebuilt installers can be found in `installer-build/`

---

### Logs and diagnostics

- In‑app console: View via the main UI; double‑click an entry to open full details
- File logs: stored under `logs/` next to the executable
- Sentry: DSN is configured in `Program.cs`; events cached under `SentryCache/`
- Debug panel: UI property grid reflects `SoftwareSettings`; console shows debug entries when `DebugMode` is true

---

### License

See [LICENSE](LICENSE).
